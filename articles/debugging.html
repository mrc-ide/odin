<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>debugging • odin</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="debugging">
<meta property="og:description" content="odin">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">odin</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.5.11</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/odin.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/debugging.html">debugging</a>
    </li>
    <li>
      <a href="../articles/discrete.html">odin discrete models</a>
    </li>
    <li>
      <a href="../articles/functions.html">odin functions</a>
    </li>
    <li>
      <a href="../articles/guide.html">Guide to odin docs</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/odin/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>debugging</h1>
                        <h4 data-toc-skip class="author">Rich
FitzJohn</h4>
            
            <h4 data-toc-skip class="date">2024-07-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/odin/blob/HEAD/vignettes/debugging.Rmd" class="external-link"><code>vignettes/debugging.Rmd</code></a></small>
      <div class="hidden name"><code>debugging.Rmd</code></div>

    </div>

    
    
<p>Debugging odin models can be challenging because:</p>
<ul>
<li>They’re not composable - you end up with a fairly large set of
equations that govern your system, and you can’t easily split this into
smaller testable units and compose them together.</li>
<li>You are writing in the DSL but the model runs in some other
language; this sometimes behaves unexpectedly and is much less
inspectable than just using R</li>
<li>You can’t (easily) interrupt the running of the program at any point
and inspect it</li>
</ul>
<p>Here, we outline some strategies for debugging, and describe the new
features that aim to make this easier.</p>
<div class="section level2">
<h2 id="using-print">Using <code>print()</code><a class="anchor" aria-label="anchor" href="#using-print"></a>
</h2>
<p>As of odin 1.4.5, you can print the value of some variables in the
middle of running your model. We will expand and change this
functionality in future versions, your feedback is very welcome.</p>
<p>Consider the simple model below, which illustrates the idea:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gen</span> <span class="op">&lt;-</span> <span class="fu">odin</span><span class="fu">::</span><span class="fu"><a href="../reference/odin.html">odin</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/deriv.html" class="external-link">deriv</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span>  <span class="fu">initial</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"x: {x}"</span><span class="op">)</span></span>
<span><span class="op">}</span>, debug_enable <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required namespace: pkgbuild</span></span></code></pre>
<pre><code><span><span class="co">## Generating model in c</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Re-compiling <span style="color: #0000BB;">odin156e6554</span> (debug build)</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">──</span> <span style="color: #00BBBB;">R CMD INSTALL</span> <span style="color: #00BBBB;">───────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">## * installing *source* package ‘odin156e6554’ ...</span></span>
<span><span class="co">## ** using staged installation</span></span>
<span><span class="co">## ** libs</span></span>
<span><span class="co">## using C compiler: ‘gcc (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0’</span></span>
<span><span class="co">## gcc -I"/opt/R/4.4.1/lib/R/include" -DNDEBUG   -I/usr/local/include    -fpic  -g -O2  -UNDEBUG -Wall -pedantic -g -O0 -fdiagnostics-color=always -c odin.c -o odin.o</span></span>
<span><span class="co">## <span style="font-weight: bold;">odin.c:</span> In function ‘<span style="font-weight: bold;">odin_metadata</span>’:</span></span>
<span><span class="co">## <span style="font-weight: bold;">odin.c:76:18:</span> <span style="color: #BB00BB; font-weight: bold;">warning: </span>unused variable ‘<span style="font-weight: bold;">internal</span>’ [<span style="color: #BB00BB; font-weight: bold;">-Wunused-variable</span>]</span></span>
<span><span class="co">##    76 |   odin_internal *<span style="color: #BB00BB; font-weight: bold;">internal</span> = odin_get_internal(internal_p, 1);</span></span>
<span><span class="co">##       |                  <span style="color: #BB00BB; font-weight: bold;">^~~~~~~~</span></span></span>
<span><span class="co">## gcc -I"/opt/R/4.4.1/lib/R/include" -DNDEBUG   -I/usr/local/include    -fpic  -g -O2  -UNDEBUG -Wall -pedantic -g -O0 -fdiagnostics-color=always -c registration.c -o registration.o</span></span>
<span><span class="co">## gcc -shared -L/opt/R/4.4.1/lib/R/lib -L/usr/local/lib -o odin156e6554.so odin.o registration.o -L/opt/R/4.4.1/lib/R/lib -lR</span></span>
<span><span class="co">## installing to /tmp/RtmpnoL1KI/devtools_install_186f5ec86705/00LOCK-file186f38008d9d/00new/odin156e6554/libs</span></span>
<span><span class="co">## ** checking absolute paths in shared objects and dynamic libraries</span></span>
<span><span class="co">## * DONE (odin156e6554)</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Loading <span style="color: #0000BB;">odin156e6554</span></span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="va">gen</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">mod</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [0.000000] x: 1.000000</span></span>
<span><span class="co">## [0.000100] x: 1.000100</span></span>
<span><span class="co">## [0.000100] x: 1.000100</span></span>
<span><span class="co">## [0.000200] x: 1.000200</span></span>
<span><span class="co">## [0.000200] x: 1.000200</span></span>
<span><span class="co">## [0.020796] x: 1.021012</span></span>
<span><span class="co">## [0.020796] x: 1.021014</span></span>
<span><span class="co">## [0.041392] x: 1.042257</span></span>
<span><span class="co">## [0.041392] x: 1.042262</span></span>
<span><span class="co">## [0.061987] x: 1.063947</span></span>
<span><span class="co">## [0.061987] x: 1.063951</span></span>
<span><span class="co">## [0.121251] x: 1.128890</span></span>
<span><span class="co">## [0.121251] x: 1.128907</span></span></code></pre>
<pre><code><span><span class="co">##     t        x</span></span>
<span><span class="co">## 1 0.0 1.000000</span></span>
<span><span class="co">## 2 0.1 1.105171</span></span></code></pre>
<p>Here we’ve told odin that we want to watch the variable
<code>x</code> and print its value at every evaluation (the third line
of the model code) and to include generated code that actually prints
the debugging information (<code>debug_enable = TRUE</code>). When we
run the model it prints out the time in square brackets then the debug
information following. Notice that we only requested the solution at
times 0 and 0.1 but the debug information shows every point in time that
the ODE solver evaluated this system of equations.</p>
<p>While this function shares its name with R’s <code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code> it
has entirely different functionality.</p>
<p>Importantly, adding the <code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code> statement to a model has
no effect unless it is compiled with <code>debug_enable = TRUE</code>.
It’s safe to leave these statements in with no performance cost as if
<code>debug_enable = FALSE</code> (the default) odin will simply not
generate any related code.</p>
<div class="section level3">
<h3 id="print-format-strings">
<code>print</code> format strings<a class="anchor" aria-label="anchor" href="#print-format-strings"></a>
</h3>
<p>For print formatting, we use <a href="https://glue.tidyverse.org/" class="external-link">glue</a> to drive the formatting, and
if you have used that package the format will feel familiar.</p>
<p>The most simple usage is as above; you can refer to variables within
<code>{curly braces}</code>; so long as your variable is a scalar this
will work. Outside of curly braces the string is printed verbatim.</p>
<div class="section level4">
<h4 id="conditional-display">Conditional display<a class="anchor" aria-label="anchor" href="#conditional-display"></a>
</h4>
<p>If your model takes many steps, or if you want to narrow down on a
problem, you may want to enable conditional display of your debug
information. Use the argument <code>when =</code> to control display,
such as</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"x: {x}"</span>, when <span class="op">=</span> <span class="va">x</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>which will display the value of <code>x</code> when it is greater
than 1. You can chain together expressions with parentheses and
<code>&amp;&amp;</code> or <code>||</code> and reference any value in
your system. For example:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">printf</span><span class="op">(</span><span class="st">"{x} {y} {z}"</span>, when <span class="op">=</span> <span class="va">x</span> <span class="op">&gt;</span> <span class="op">(</span><span class="va">x</span> <span class="op">+</span> <span class="va">y</span> <span class="op">+</span> <span class="va">z</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">&amp;&amp;</span> <span class="va">a</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="controlling-precision">Controlling precision<a class="anchor" aria-label="anchor" href="#controlling-precision"></a>
</h4>
<p>You can control the way that quantities are displayed through the use
of formatting options. The formatting is the same as used by R, so you
can experiment in the console easily. The default is to print as a
generic floating point number, so this:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"x: {x}, y: {y}"</span><span class="op">)</span></span></code></pre></div>
<p>is roughly equivalent to writing</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"x: %f, y: %f"</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span></code></pre></div>
<p>See <code><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">?sprintf</a></code> for more information; but this defaults to
6 decimal places of precision. This may not be appropriate if you are
dealing with numbers that are very large or very small; these both look
a bit silly:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"x: %f, y: %f"</span>, <span class="fl">1e-7</span>, <span class="fl">1e7</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "x: 0.000000, y: 10000000.000000"</span></span></code></pre>
<p>The first loses all information - the only non-zero parts of the
number fall after the precision cut-off, while in the second the 6
decimal places just add noise. So above we might prefer:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"x: %g, y: %g"</span>, <span class="fl">1e-7</span>, <span class="fl">1e7</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "x: 1e-07, y: 1e+07"</span></span></code></pre>
<p>which we could write in odin’s approach as</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"x: {x; g}, y: {y; g}"</span><span class="op">)</span></span></code></pre></div>
<p>Anything after the <code>;</code> is interpreted as a format
specifier. You could also do</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"x: {x; g}, y: {y; .2f}"</span><span class="op">)</span></span></code></pre></div>
<p>which would format <code>y</code> to 2 decimal places. We follow here
the example of the <a href="https://glue.tidyverse.org/articles/transformers.html#sprintf-transformer" class="external-link">sprintf
transformer example in glue</a> by not including the <code>%</code>
placeholder, but allow all formats that the underlying library
supports.</p>
</div>
</div>
<div class="section level3">
<h3 id="current-limitations">Current limitations<a class="anchor" aria-label="anchor" href="#current-limitations"></a>
</h3>
<p>This is an experimental interface, and it has not been exposed to
much real-world use. As such it is possible that you might write fairly
innocent looking code and it produce a compiler error rather than a
nicer R error - please let us know so we can fix this.</p>
<ul>
<li>There’s no good way of printing out the contents of an array aside
from indexing into it. That’s possibly a reasonable thing to do though,
given that most arrays get very large very quickly.</li>
<li>You can’t yet control the way that time is formatted (e.g.,
disabling it or changing the precision)</li>
<li>The print statement only runs in your right-hand-side function (ODE
models) or update function (discrete time models) and so it’s possible
that some variables that you refer to in your print statements won’t
exist in this function (e.g., transient quantities used only to compute
some initial condition). We hope this is rare in real-use examples but
welcome minimal examples that show where this causes problems (likely
you will see a compiler error)</li>
<li>We print the result at the end of the rhs/update function; if you
have a crash (or are writing off the end of memory) then this might not
be what you want (e.g., the variables you see are the ones in the
iteration prior to the crash, or after they have been overwritten by
junk). We may support printing more eagerly, after all dependencies in
the expression are satisfied, with an additional option to
<code>print</code>
</li>
<li>Be careful of using integer printing (e.g., <code>{x; d}</code>) for
variables that are merely integer-like, or you will get unexpected junk
output out.</li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Rich FitzJohn.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
