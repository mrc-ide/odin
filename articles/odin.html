<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Odin • odin</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Odin">
<meta property="og:description" content="odin">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">odin</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/odin.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/discrete.html">Discrete models using odin</a>
    </li>
    <li>
      <a href="../articles/functions.html">Odin Functions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/odin/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="odin_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Odin</h1>
                        <h4 class="author">Rich FitzJohn</h4>
            
            <h4 class="date">2020-12-15</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/odin/blob/master/vignettes/odin.Rmd"><code>vignettes/odin.Rmd</code></a></small>
      <div class="hidden name"><code>odin.Rmd</code></div>

    </div>

    
    
<div id="single-variable-logistic-growth" class="section level1">
<h1 class="hasAnchor">
<a href="#single-variable-logistic-growth" class="anchor"></a>Single variable: Logistic growth</h1>
<p>We’ll first start with a very simple model; logistic growth. We have one variable <code>N</code> which grows towards a carrying capacity <code>K</code>. The growth rate is <code>r</code> when <code>N</code> is very small (note that this equation can be easily solved analytically and it’s only included here for demonstration!)</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">path_logistic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"examples/logistic.R"</span>, package <span class="op">=</span> <span class="st">"odin"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/deriv.html">deriv</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op">*</span> <span class="va">N</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">N</span> <span class="op">/</span> <span class="va">K</span><span class="op">)</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N0</span>

<span class="va">N0</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">r</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></code></pre></div>
<p>The time derivatives are indicated by <code>deriv(N) &lt;-</code>; the right hand side of this is the differential equation. Initial conditions are always given (future versions may make them optional) and can be in terms of variables. Note that the definition of declaration is not important; the derivative calculation references parameters <code>r</code> and <code>K</code> which have not been defined and the initial conditions reference <code>N0</code>.</p>
<p><strong>NOTE</strong> while this <em>looks</em> like R (and must <em>parse</em> as R) it is not actually R code. Copying and pasting this code into an R session would throw an error</p>
<p>To compile this as a standalone model (not suitable for inclusion in a package) use <code><a href="../reference/odin.html">odin::odin</a></code>;</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">generator</span> <span class="op">&lt;-</span> <span class="fu">odin</span><span class="fu">::</span><span class="fu"><a href="../reference/odin.html">odin</a></span><span class="op">(</span><span class="va">path_logistic</span><span class="op">)</span></code></pre></div>
<pre><code>## Loading required namespace: pkgbuild</code></pre>
<p>This returns a function that will generate an instance of the model:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">generator</span><span class="op">(</span><span class="op">)</span>
<span class="va">mod</span></code></pre></div>
<pre><code>## &lt;odin_model&gt;
##   Public:
##     contents: function () 
##     deriv: function (t, y) 
##     initial: function (t) 
##     initialize: function (..., user = list(...), use_dde = FALSE, unused_user_action = NULL) 
##     ir: function () 
##     rhs: function (t, y) 
##     run: function (t, y = NULL, ..., use_names = TRUE) 
##     set_user: function (..., user = list(...), unused_user_action = NULL) 
##     transform_variables: function (y) 
##   Private:
##     cfuns: list
##     dll: logistic5cbfe8b4
##     interpolate_t: NULL
##     n_out: 0
##     odin: environment
##     output_order: NULL
##     ptr: externalptr
##     registration: function () 
##     set_initial: function (t, y, use_dde) 
##     update_metadata: function () 
##     use_dde: FALSE
##     user: NULL
##     variable_order: list
##     ynames: t N</code></pre>
<p>This is an <code>ode_system</code> object and can be used to run the system of differential equations, query the internal state, and so on. Most of the listed elements above do not need to be accessed ever (I would make them private but that incurs a very slight performance cost).</p>
<p>The initial conditions:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span><span class="op">$</span><span class="va">init</span></code></pre></div>
<pre><code>## NULL</code></pre>
<p>dN/dt evaluated at the time zero, with the initial conditions:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span><span class="op">$</span><span class="fu">deriv</span><span class="op">(</span><span class="fl">0</span>, <span class="va">mod</span><span class="op">$</span><span class="fu">initial</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.495</code></pre>
<p>or with arbitrary conditions:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span><span class="op">$</span><span class="fu">deriv</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 12.5</code></pre>
<p>To see the contents of all the variables, intermediates and parameters tracked by odin use <code>contents()</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span><span class="op">$</span><span class="fu">contents</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## $initial_N
## [1] 1
## 
## $K
## [1] 100
## 
## $N0
## [1] 1
## 
## $r
## [1] 0.5</code></pre>
<p>To run the model, provide a set of times:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">30</span>, length.out <span class="op">=</span> <span class="fl">101</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">tt</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">y</span>, xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"N"</span>, las <span class="op">=</span> <span class="fl">1</span>, main <span class="op">=</span> <span class="st">""</span><span class="op">)</span></code></pre></div>
<p><img src="odin_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<p>While initial conditions are computed, you may pass in arbitrary initial conditions;</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">y2</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">tt</span>, <span class="fl">50</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">y</span>, xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"N"</span>, las <span class="op">=</span> <span class="fl">1</span>, main <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">y2</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></code></pre></div>
<p><img src="odin_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<div id="specifying-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#specifying-parameters" class="anchor"></a>Specifying parameters</h2>
<p>The above is about the simplest possible useful model I could come up with. But it’s not that useful because all the parameters are hard coded into the model. Here’s a slightly tweaked version where the parameters may be specified at runtime:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">generator</span> <span class="op">&lt;-</span> <span class="fu">odin</span><span class="fu">::</span><span class="fu"><a href="../reference/odin.html">odin</a></span><span class="op">(</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/deriv.html">deriv</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op">*</span> <span class="va">N</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">N</span> <span class="op">/</span> <span class="va">K</span><span class="op">)</span>
  <span class="fu">initial</span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N0</span>

  <span class="va">N0</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
  <span class="va">K</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>
  <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>when used as <code>user(1)</code> (as for <code>N</code> and <code>K</code>) it means we allow a user parameter called <code>N0</code> to be specified, but if omitted it has a default value of 1. When used as <code>user()</code> (as for <code>r</code>) it means that there is no default value and <code>r</code> <strong>must</strong> be provided.</p>
<p>Note this example takes the code of the model as its first argument. It can also be specified as text, but the form above should be nicer to write than text, especially in editors with support for things like autocompletion.</p>
<p>Because <code>r</code> is required, it is an error to initialise the model without any parameters:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">generator</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## Error in self$set_user(user = user, unused_user_action = unused_user_action): Expected a value for 'r'</code></pre>
<p>Providing <code>r</code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">generator</span><span class="op">(</span>r <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>The model contains the set value of r</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span><span class="op">$</span><span class="fu">contents</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">r</span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>Running the model shows the effect of doubling the growth rate:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">y3</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">tt</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">y</span>, xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"N"</span>, las <span class="op">=</span> <span class="fl">1</span>, main <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">y3</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></code></pre></div>
<p><img src="odin_files/figure-html/unnamed-chunk-15-1.png" width="672"></p>
<p>Once created a model can have the parameters re-set:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span><span class="op">$</span><span class="fu">set_user</span><span class="op">(</span>r <span class="op">=</span> <span class="fl">0.25</span>, K <span class="op">=</span> <span class="fl">75</span>, N0 <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="va">y4</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">tt</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">y</span>, xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"N"</span>, las <span class="op">=</span> <span class="fl">1</span>, main <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">y3</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">y4</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></code></pre></div>
<p><img src="odin_files/figure-html/unnamed-chunk-16-1.png" width="672"></p>
</div>
</div>
<div id="more-than-one-variable-the-lorenz-attractor" class="section level1">
<h1 class="hasAnchor">
<a href="#more-than-one-variable-the-lorenz-attractor" class="anchor"></a>More than one variable: the Lorenz attractor</h1>
<p>Once more than one variable is involved, there is a bit more book-keeping to take care of.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">path_lorenz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"examples/lorenz.R"</span>, package <span class="op">=</span> <span class="st">"odin"</span><span class="op">)</span></code></pre></div>
<p>The Lorenz attractor is a set of coupled ODEs that displays chaotic behaviour. It was found by reducing a set of equations describing atmospheric convection in the 1960s. Mostly I just think it looks pretty.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/deriv.html">deriv</a></span><span class="op">(</span><span class="va">y1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">sigma</span> <span class="op">*</span> <span class="op">(</span><span class="va">y2</span> <span class="op">-</span> <span class="va">y1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/deriv.html">deriv</a></span><span class="op">(</span><span class="va">y2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">R</span> <span class="op">*</span> <span class="va">y1</span> <span class="op">-</span> <span class="va">y2</span> <span class="op">-</span> <span class="va">y1</span> <span class="op">*</span> <span class="va">y3</span>
<span class="fu"><a href="https://rdrr.io/r/stats/deriv.html">deriv</a></span><span class="op">(</span><span class="va">y3</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">b</span> <span class="op">*</span> <span class="va">y3</span> <span class="op">+</span> <span class="va">y1</span> <span class="op">*</span> <span class="va">y2</span>

<span class="fu">initial</span><span class="op">(</span><span class="va">y1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">10.0</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">y2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1.0</span>
<span class="fu">initial</span><span class="op">(</span><span class="va">y3</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1.0</span>

<span class="co">## These are the classical parameters:</span>
<span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="va">R</span> <span class="op">&lt;-</span> <span class="fl">28</span>
<span class="va">b</span> <span class="op">&lt;-</span>  <span class="fl">8</span> <span class="op">/</span> <span class="fl">3</span></code></pre></div>
<p>The system is not chaotic with all parameters. The initial conditions are fairly arbitrary here as the system will settle into its characteristic shape from most points (though with completely different realisations).</p>
<p>Building the generator, and from that a system, is the same as the above:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">generator</span> <span class="op">&lt;-</span> <span class="fu">odin</span><span class="fu">::</span><span class="fu"><a href="../reference/odin.html">odin</a></span><span class="op">(</span><span class="va">path_lorenz</span><span class="op">)</span>
<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">generator</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Because of the rapid changes that characterise this model, we’ll take a <em>lot</em> of samples.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, length.out <span class="op">=</span> <span class="fl">20000</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">tt</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.008   0.001   0.009</code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html">pairs</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1L</span><span class="op">]</span>, panel <span class="op">=</span> <span class="va">lines</span>, lwd <span class="op">=</span> <span class="fl">.2</span>, col <span class="op">=</span> <span class="st">"#00000055"</span><span class="op">)</span></code></pre></div>
<p><img src="odin_files/figure-html/unnamed-chunk-20-1.png" width="672"></p>
</div>
<div id="delay-models" class="section level1">
<h1 class="hasAnchor">
<a href="#delay-models" class="anchor"></a>Delay models</h1>
<p>Models with lags and delays represent a challenge in solving and representing the system, see <a href="https://en.wikipedia.org/wiki/Delay_differential_equation">this wikipedia article</a> for some of the issues. In the general case this gives a set of partial differential equations, which are much harder to solve generally than ordinary differential equations.</p>
<p>Like Berkeley Madonna, <code>odin</code> allows solving equations with lags, using the machinery available in <code>deSolve</code>. One can specify a lag in a state variable or an expression. The lag times can also be variables.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gen</span> <span class="op">&lt;-</span> <span class="fu">odin</span><span class="fu">::</span><span class="fu"><a href="../reference/odin.html">odin</a></span><span class="op">(</span><span class="op">{</span>
  <span class="va">ylag</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/base-defunct.html">delay</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">tau</span><span class="op">)</span>
  <span class="fu">initial</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0.5</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/deriv.html">deriv</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="va">ylag</span> <span class="op">*</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">ylag</span><span class="op">^</span><span class="fl">10</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">y</span>
  <span class="va">tau</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
  <span class="fu">output</span><span class="op">(</span><span class="va">ylag</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">ylag</span>
<span class="op">}</span><span class="op">)</span>
<span class="va">dde</span> <span class="op">&lt;-</span> <span class="fu">gen</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>The first line here</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ylag</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/base-defunct.html">delay</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">tau</span><span class="op">)</span></code></pre></div>
<p>specifies the delay; it says that <code>ylag</code> should be equal to <code>y</code> from <code>tau</code> ago. Or; <code>ylag(t) = y(t - tau)</code>.</p>
<p><code>delay</code> expressions must be the only expressions on the rhs of an assignment. The first argument can be a single variable (like here) or it can be an expression.</p>
<p>Running the model will automatically use the <code><a href="https://rdrr.io/pkg/deSolve/man/dede.html">deSolve::dede</a></code> function.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">300</span>, length.out <span class="op">=</span> <span class="fl">301</span><span class="op">)</span>
<span class="va">y1</span> <span class="op">&lt;-</span> <span class="va">dde</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">y1</span>, ylab <span class="op">=</span> <span class="st">"y"</span>, mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, which <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">y1</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1L</span><span class="op">]</span>, xlab <span class="op">=</span> <span class="st">"y"</span>, ylab <span class="op">=</span> <span class="st">"ylag"</span>, mfrow <span class="op">=</span> <span class="cn">NULL</span>, type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></code></pre></div>
<p><img src="odin_files/figure-html/unnamed-chunk-22-1.png" width="672"></p>
<p>Increasing the lag time creates much more complicated trajectories:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dde</span><span class="op">$</span><span class="fu">set_user</span><span class="op">(</span>tau <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>
<span class="va">y2</span> <span class="op">&lt;-</span> <span class="va">dde</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">y2</span>, ylab <span class="op">=</span> <span class="st">"y"</span>, mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, which <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">y2</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1L</span><span class="op">]</span>, xlab <span class="op">=</span> <span class="st">"y"</span>, ylab <span class="op">=</span> <span class="st">"ylag"</span>, mfrow <span class="op">=</span> <span class="cn">NULL</span>, type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></code></pre></div>
<p><img src="odin_files/figure-html/unnamed-chunk-23-1.png" width="672"></p>
</div>
<div id="arrays" class="section level1">
<h1 class="hasAnchor">
<a href="#arrays" class="anchor"></a>Arrays</h1>
<p>Much of the above, especially the non-delay equations, can be expressed easily in deSolve. Even where the target functions are written in R they will tend to be fast enough to solve (unless strongly non-linear) so that the gains for writing out in C become small. <code>odin</code> was really designed for cases where the variables involved are <em>arrays</em>, used here to mean vectors, matrices or 3d matrices.</p>
<p>There are quite a few restrictions on how arrays are used, how indexing works, etc. Some of the current implementation requires creation of intermediate variables to make everything work (and naming things is one of the <a href="https://www.quora.com/Why-is-naming-things-hard-in-computer-science-and-how-can-it-can-be-made-easier">two hard problems in computer science</a>. Hopefully in future versions some of these restrictions can be relaxed, so <a href="https://github.com/mrc-ide/odin/issues">file issues</a> if you find yourself writing boilerplate code that could be replaced by more intelligent generation.</p>
<div id="generalised-lotka-volterra-model" class="section level2">
<h2 class="hasAnchor">
<a href="#generalised-lotka-volterra-model" class="anchor"></a>Generalised Lotka-Volterra model</h2>
<p>This example comes from the <a href="https://en.wikipedia.org/wiki/Competitive_Lotka%E2%80%93Volterra_equations#4-dimensional_example">wikipedia page</a>, in turn from <a href="http://sprott.physics.wisc.edu/pubs/paper288.pdf">Vano et al 2006</a>. This model has four non-linear differential equations that have chaotic behaviour in fairly low dimension.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gen</span> <span class="op">&lt;-</span> <span class="fu">odin</span><span class="fu">::</span><span class="fu"><a href="../reference/odin.html">odin</a></span><span class="op">(</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/deriv.html">deriv</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">r</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">ay</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span>
  <span class="fu">initial</span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">y0</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>

  <span class="va">y0</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="va">r</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="va">a</span><span class="op">[</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="va">ay</span><span class="op">[</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">a</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">*</span> <span class="va">y</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>

  <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="va">n_spp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">n_spp</span>
  <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">y0</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">n_spp</span>
  <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n_spp</span>, <span class="va">n_spp</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">ay</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n_spp</span>, <span class="va">n_spp</span><span class="op">)</span>

  <span class="fu">config</span><span class="op">(</span><span class="va">base</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"lv4"</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>These are the parameters from the wikipedia article, with <code>y0</code> being close to the (unstable) equilibrium.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.00</span>, <span class="fl">0.72</span>, <span class="fl">1.53</span>, <span class="fl">1.27</span><span class="op">)</span>,
             a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.00</span>, <span class="fl">1.09</span>, <span class="fl">1.52</span>, <span class="fl">0.00</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.00</span>, <span class="fl">1.00</span>, <span class="fl">0.44</span>, <span class="fl">1.36</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.33</span>, <span class="fl">0.00</span>, <span class="fl">1.00</span>, <span class="fl">0.47</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.21</span>, <span class="fl">0.51</span>, <span class="fl">0.35</span>, <span class="fl">1.00</span><span class="op">)</span><span class="op">)</span>,
             y0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.3013</span>, <span class="fl">0.4586</span>, <span class="fl">0.1307</span>, <span class="fl">0.3557</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Note that we pass in <code>r</code> as a matrix, from which the number of species is determined. The competitive matrix <code>a</code> is passed through as a matrix – both dimensions must be the same as the length of <code>r</code> (you can’t just pass in a vector and hope it gets unpacked in the right order).</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">gen</span><span class="op">(</span>user <span class="op">=</span> <span class="va">pars</span><span class="op">)</span>

<span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2000</span>, length.out <span class="op">=</span> <span class="fl">10001</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html">pairs</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span>, panel <span class="op">=</span> <span class="va">lines</span>, col <span class="op">=</span> <span class="st">"#00000055"</span>, lwd <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></code></pre></div>
<p><img src="odin_files/figure-html/unnamed-chunk-26-1.png" width="672"></p>
</div>
</div>
<div id="interpolating-functions" class="section level1">
<h1 class="hasAnchor">
<a href="#interpolating-functions" class="anchor"></a>Interpolating functions</h1>
<p>It may be useful to have functions that are driven by user data in your model. To allow this, odin allows interpolating functions of a few different types;</p>
<ul>
<li>step functions: constant piecewise functions, perhaps suitable for modelling shifts in regime, binary on/off switches, etc.</li>
<li>linear interpolation: between a set of points use a linear interpolating function.</li>
<li>cubic spline functions: what most people probably think of when thinking interpolating function; creates a smooth function that is twice differentiable (and smooth enough for most purposes). In contrast with the splines R uses with <code><a href="https://rdrr.io/r/stats/splinefun.html">spline()</a></code>, these use the <em>natural spline</em> end conditions, and are equal to <code><a href="https://rdrr.io/r/stats/splinefun.html">spline(t, y, method = "natural")</a></code>.</li>
</ul>
<p>The <code>interpolate</code> takes as its first argument a vector of times. If you’re using constant or linear interpolating functions it is important that you include these times within times that the integrator passes through because otherwise the integrator may struggle needlessly with the discontinuities in the function or its derivatives (NOTE: future versions may handle this automatically, and this will not work at all with <code>dde</code> which does not yet support stopping at critical times).</p>
<p>The second argument of each interpolating function is a vector, matrix or array of values for the target function. The dimensionality (rank) of the structure must be one greater than the rhs. So if you want a classic 1d function, you’d write:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu">interpolate</span><span class="op">(</span><span class="va">tt</span>, <span class="va">y</span><span class="op">)</span>
<span class="va">tt</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
<span class="va">y</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">tt</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">tt</span><span class="op">)</span></code></pre></div>
<p>and <code>z</code> will be a scalar double, and <code>t</code> and <code>y</code> are both vectors with lengths that must match. The check for matching is done at runtime (when the model is initialised) so you can always just leave the dimensions as <code>user()</code>. Future versions may allow autogeneration of the boilerplate here, but for now you must specify the four lines required to initialise <code>t</code> and <code>y</code>.</p>
<p>Note that <code>t</code> cannot be used as the first argument because it’s a reserved variable!</p>
<p>If you want to interpolate a <em>vector</em> of <code>y</code> values over time, then you’d write:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">z</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">interpolate</span><span class="op">(</span><span class="va">tt</span>, <span class="va">y</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">4</span>
<span class="va">tt</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
<span class="va">y</span><span class="op">[</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">tt</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">tt</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>In this case, <code>z</code> is a vector (here length 4), so <code>y</code> must be a matrix with <code><a href="https://rdrr.io/r/base/length.html">length(t)</a></code> rows and 4 columns. This does not do anything clever - the interpolation happens for each of the four variables independently.</p>
<p>If you want to drive the size of this off of <code>y</code> then specify:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
<span class="co"># (other entries same as above)</span></code></pre></div>
<p>in which case the size of <code>z</code> is determined from the number of columns of <code>y</code>.</p>
<p>By default, <code>odin</code> assumes you want do do cubic interpolation, but you can alter that with the third argument. Specify <code>"constant"</code> to indicate constant interpolation and <code>"linear"</code> to indicate linear interpolation.</p>
<p>All modes of interpolation use a fast lookup (bisection search that remembers where it started from on the last lookup) to try and make interpolation as fast as possible. Performance should be <em>O(log(n))</em> in the number of points used to create the interpolating function, so the penalty for using many points in your interpolation should be low.</p>
<p>No care is taken about making sure that the integration stops at painful parts of your interpolating function. So, especially for the constant interpolation, be sure to include the switch points in the time vector (currently this will not work for <code>dde</code> which never stops at a specified point except for the start and end point). Future versions, especially once events are handled, may do this automatically.</p>
<p>As an example, here is the flux model from the deSolve compiledCode vignette (see <code>vignette("compiledCode")</code>, section 6).</p>
<p>The model here is:</p>
<p>dC/dt = flux(t) - k * C</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">flux_model</span> <span class="op">&lt;-</span> <span class="fu">odin</span><span class="fu">::</span><span class="fu"><a href="../reference/odin.html">odin</a></span><span class="op">(</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/deriv.html">deriv</a></span><span class="op">(</span><span class="va">C</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">flux</span> <span class="op">-</span> <span class="va">kk</span> <span class="op">*</span> <span class="va">C</span>
  <span class="fu">initial</span><span class="op">(</span><span class="va">C</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">C0</span>
  <span class="va">flux</span> <span class="op">&lt;-</span> <span class="fu">interpolate</span><span class="op">(</span><span class="va">flux_t</span>, <span class="va">flux_y</span>, <span class="st">"linear"</span><span class="op">)</span>
  <span class="va">C0</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="va">kk</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="fu">output</span><span class="op">(</span><span class="va">deposition</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">kk</span> <span class="op">*</span> <span class="va">C</span>
  <span class="co">## Fair bit of boilerplate here that may be removed in future</span>
  <span class="co">## versions:</span>
  <span class="va">flux_t</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="va">flux_y</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">flux_t</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">flux_y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>Here we arrange for the components of the interpolating function to be passed through as user vectors, which is the only way of specifying these models at present. The interpolation type, here “linear”, is hard coded and cannot be changed at runtime.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">flux_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">11</span>, <span class="fl">21</span>, <span class="fl">41</span>, <span class="fl">73</span>, <span class="fl">83</span>, <span class="fl">93</span>, <span class="fl">103</span>, <span class="fl">113</span>, <span class="fl">123</span>, <span class="fl">133</span>, <span class="fl">143</span>, <span class="fl">153</span>,
            <span class="fl">163</span>, <span class="fl">173</span>, <span class="fl">183</span>, <span class="fl">194</span>, <span class="fl">204</span>, <span class="fl">214</span>, <span class="fl">224</span>, <span class="fl">234</span>, <span class="fl">244</span>, <span class="fl">254</span>, <span class="fl">264</span>,
            <span class="fl">274</span>, <span class="fl">284</span>, <span class="fl">294</span>, <span class="fl">304</span>, <span class="fl">315</span>, <span class="fl">325</span>, <span class="fl">335</span>, <span class="fl">345</span>, <span class="fl">355</span>, <span class="fl">365</span><span class="op">)</span>
<span class="va">flux_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.654</span>, <span class="fl">0.167</span>, <span class="fl">0.06</span>, <span class="fl">0.07</span>, <span class="fl">0.277</span>, <span class="fl">0.186</span>, <span class="fl">0.14</span>, <span class="fl">0.255</span>, <span class="fl">0.231</span>,
            <span class="fl">0.309</span>, <span class="fl">1.127</span>, <span class="fl">1.923</span>, <span class="fl">1.091</span>, <span class="fl">1.001</span>, <span class="fl">1.691</span>, <span class="fl">1.404</span>, <span class="fl">1.226</span>, <span class="fl">0.767</span>,
            <span class="fl">0.893</span>, <span class="fl">0.737</span>, <span class="fl">0.772</span>, <span class="fl">0.726</span>, <span class="fl">0.624</span>, <span class="fl">0.439</span>, <span class="fl">0.168</span>, <span class="fl">0.28</span>, <span class="fl">0.202</span>,
            <span class="fl">0.193</span>, <span class="fl">0.286</span>, <span class="fl">0.599</span>, <span class="fl">1.889</span>, <span class="fl">0.996</span>, <span class="fl">0.681</span>, <span class="fl">1.135</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">flux_t</span>, <span class="va">flux_y</span>, type <span class="op">=</span> <span class="st">"l"</span>, ylab <span class="op">=</span> <span class="st">"Flux"</span>, xlab <span class="op">=</span> <span class="st">"Time"</span><span class="op">)</span></code></pre></div>
<p><img src="odin_files/figure-html/unnamed-chunk-28-1.png" width="672"></p>
<p>Following the deSolve vignette, the initial conditions are derived from the parameters and the flux over time:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">k</span> <span class="op">&lt;-</span> <span class="fl">0.01</span>
<span class="va">C0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/approxfun.html">approx</a></span><span class="op">(</span><span class="va">flux_t</span>, <span class="va">flux_y</span>, xout <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">365</span><span class="op">)</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">/</span> <span class="va">k</span></code></pre></div>
<p>Initialise the model:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">flux_model</span><span class="op">(</span>kk <span class="op">=</span> <span class="va">k</span>, C0 <span class="op">=</span> <span class="va">C0</span>, flux_t <span class="op">=</span> <span class="va">flux_t</span>, flux_y <span class="op">=</span> <span class="va">flux_y</span><span class="op">)</span></code></pre></div>
<p>And run over one year:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">365</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">t</span>, tcrit <span class="op">=</span> <span class="fl">365</span><span class="op">)</span></code></pre></div>
<p>The output in all its glory:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">flux_t</span>, <span class="va">flux_y</span>, type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="st">"red"</span>, ylab <span class="op">=</span> <span class="st">"Flux &amp; deposition"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">y</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></code></pre></div>
<p><img src="odin_files/figure-html/unnamed-chunk-32-1.png" width="672"></p>
<p>Alternatively, we could have used constant or spline interpolation. This (at least at present) requires re-specifying and recompiling the entire model. So, for a constant model:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">flux_model_c</span> <span class="op">&lt;-</span> <span class="fu">odin</span><span class="fu">::</span><span class="fu"><a href="../reference/odin.html">odin</a></span><span class="op">(</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/deriv.html">deriv</a></span><span class="op">(</span><span class="va">C</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">flux</span> <span class="op">-</span> <span class="va">kk</span> <span class="op">*</span> <span class="va">C</span>
  <span class="fu">initial</span><span class="op">(</span><span class="va">C</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">C0</span>
  <span class="va">flux</span> <span class="op">&lt;-</span> <span class="fu">interpolate</span><span class="op">(</span><span class="va">flux_t</span>, <span class="va">flux_y</span>, <span class="st">"constant"</span><span class="op">)</span>
  <span class="va">C0</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="va">kk</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="fu">output</span><span class="op">(</span><span class="va">flux</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">flux</span>
  <span class="fu">output</span><span class="op">(</span><span class="va">deposition</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">kk</span> <span class="op">*</span> <span class="va">C</span>
  <span class="co">## Fair bit of boilerplate here that may be removed in future</span>
  <span class="co">## versions:</span>
  <span class="va">flux_t</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="va">flux_y</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">flux_t</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">flux_y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="va">mod_c</span> <span class="op">&lt;-</span> <span class="fu">flux_model_c</span><span class="op">(</span>kk <span class="op">=</span> <span class="va">k</span>, C0 <span class="op">=</span> <span class="va">C0</span>, flux_t <span class="op">=</span> <span class="va">flux_t</span>, flux_y <span class="op">=</span> <span class="va">flux_y</span><span class="op">)</span>
<span class="va">y_c</span> <span class="op">&lt;-</span> <span class="va">mod_c</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">t</span>, tcrit <span class="op">=</span> <span class="fl">365</span><span class="op">)</span>

<span class="va">mod_c</span><span class="op">$</span><span class="va">output_order</span></code></pre></div>
<pre><code>## NULL</code></pre>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">y_c</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"s"</span>, col <span class="op">=</span> <span class="st">"red"</span>, ylab <span class="op">=</span> <span class="st">"Flux &amp; deposition"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">y_c</span><span class="op">[</span>, <span class="fl">4</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></code></pre></div>
<p><img src="odin_files/figure-html/unnamed-chunk-33-1.png" width="672"></p>
<p>Or with cubic splines:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">flux_model_s</span> <span class="op">&lt;-</span> <span class="fu">odin</span><span class="fu">::</span><span class="fu"><a href="../reference/odin.html">odin</a></span><span class="op">(</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/deriv.html">deriv</a></span><span class="op">(</span><span class="va">C</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">flux</span> <span class="op">-</span> <span class="va">kk</span> <span class="op">*</span> <span class="va">C</span>
  <span class="fu">initial</span><span class="op">(</span><span class="va">C</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">C0</span>
  <span class="va">flux</span> <span class="op">&lt;-</span> <span class="fu">interpolate</span><span class="op">(</span><span class="va">flux_t</span>, <span class="va">flux_y</span>, <span class="st">"spline"</span><span class="op">)</span>
  <span class="va">C0</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="va">kk</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="fu">output</span><span class="op">(</span><span class="va">flux</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">flux</span>
  <span class="fu">output</span><span class="op">(</span><span class="va">deposition</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">kk</span> <span class="op">*</span> <span class="va">C</span>
  <span class="co">## Fair bit of boilerplate here that may be removed in future</span>
  <span class="co">## versions:</span>
  <span class="va">flux_t</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="va">flux_y</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">flux_t</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">flux_y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">user</span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="va">mod_s</span> <span class="op">&lt;-</span> <span class="fu">flux_model_s</span><span class="op">(</span>kk <span class="op">=</span> <span class="va">k</span>, C0 <span class="op">=</span> <span class="va">C0</span>, flux_t <span class="op">=</span> <span class="va">flux_t</span>, flux_y <span class="op">=</span> <span class="va">flux_y</span><span class="op">)</span>
<span class="va">y_s</span> <span class="op">&lt;-</span> <span class="va">mod_s</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">t</span>, tcrit <span class="op">=</span> <span class="fl">365</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">y_s</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="st">"red"</span>, ylab <span class="op">=</span> <span class="st">"Flux &amp; deposition"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">y_s</span><span class="op">[</span>, <span class="fl">4</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></code></pre></div>
<p><img src="odin_files/figure-html/unnamed-chunk-34-1.png" width="672"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Rich FitzJohn.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
