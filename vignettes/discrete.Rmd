---
title: "Discrete models using odin"
author: "Thibaut Jombart, Rich FitzJohn"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{discrete-odin}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

``` {r setup, echo = FALSE, results = "hide"}
lang_output <- function(x, lang) {
  cat(c(sprintf("```%s", lang), x, "```"), sep = "\n")
}
c_output <- function(x) lang_output(x, "cc")
r_output <- function(x) lang_output(x, "r")
plain_output <- function(x) lang_output(x, "plain")
knitr::opts_chunk$set(
  fig.width = 7,
  fig.height = 5)
```


# Discrete compartmental models in a nutshell

## From continuous to discrete time

In its simplest form, a SIR model is typically written in continuous time as:

$$
\frac{dS}{dt} = - \beta \frac{S_t I_t}{N_t}
$$

$$
\frac{dI}{dt} = \beta \frac{S_t I_t}{N_t} - \gamma I_t
$$

$$
\frac{dR}{dt} = \gamma I_t
$$

Where $\beta$ is an infection rate and $\gamma$ a removal rate, assuming 'R'
stands for 'reconvered', which can mean recovery or death.

For discrete time equivalent, we take a small time step $t$ (typically a day),
and write the changes of individuals in each compartments as:

$$
S_{t+1} = S_t - \beta \frac{S_t I_t}{N_t}
$$

$$
I_{t+1} = I_t + \beta \frac{S_t I_t}{N_t} - \gamma I_t
$$

$$
R_{t+1} = R_t + \gamma I_t
$$



## Stochastic processes

The discrete model above remains deterministic: for given values of the rates
$\beta$ and $\gamma$, dynamics will be fixed. It is fairly straightforward to
convert this discrete model into a stochastic one: one merely needs to uses
appropriate probability distributions to model the transfer of individuals
across compartments. There are at least 3 types of such distributions which will
be useful to consider.


### Binomial distribution

This distribution will be used to determine numbers of individuals **leaving** a
given compartment. While we may be tempted to use a Poisson distribution with
the rates specified in the equations above, this could lead to over-shooting,
i.e. more individuals leaving a compartment than there actually are. To avoid
infecting more people than there are susceptibles, we use a binomial
distribution, with one draw for each individual in the compartment of
interest. The workflow will be:

1. determine a *per-capita probability* of leaving the compartment, based on the
original rates specified in the equations; if the rate at which each individual
leaves a compartment is $\lambda$, then the corresponding probability of this
individual leaving the compartment in one time unit is $p = 1 - e^{- \lambda}$.

2. determine the number of individuals leaving the compartment using a *Binomial*
distribution, with one draw per individual and a probability $p$

As a example, let us consider transition $S \rightarrow I$ in the SIR model. The
overal rate at which this change happens is $\beta \frac{S_t I_t}{N_t}$. The
corresponding *per susceptible* rate is $\beta \frac{I_t}{N_t}$. Therefore, the
probability for an individual to move from *S* to *I* at time $t$ is
$p_{(S \rightarrow I), t} = 1 - e^{- \beta \frac{I_t}{N_t}}$.



### Poisson distribution

Poisson distributions will be useful when individuals enter a compartment at a
given rate, from 'the outside'. This could be birth or migration (for $S$), or
introduction of infections from an external reservoir (for $I$), etc. The
essential distinction with the previous process is that individuals are *not
leaving* an existing compartment.

This case is simple to handle: one just needs to draw new individuals entering
the compartment from a Poisson distribution with the rate directly coming form
the equations.

For instance, let us now consider a variant of the SIR model where new
infectious cases are imported at a constant rate $\epsilon$. The only change
to the equation is for the infected compartment:

$$
I_{t+1} = I_t + \beta \frac{S_t I_t}{N_t} + \epsilon - \gamma I_t
$$

where:

- individuals move from $S$ to $I$ according to a Binomial distribution
$\mathcal{B}(S_t, 1 - e^{- \beta \frac{I_t}{N_t}})$

- new infected individuals are imported according to a Poisson distribution
$\mathcal{P}(\epsilon)$

- individual move from $I$ to $R$ according to a Binomial distribution
$\mathcal{B}(I_t, 1 - e^{- \gamma})$



### Multinomial distribution

This distribution will be useful when individuals leaving a compartment are
distributed over several compartments. The Multinomial distribution will be used
to determine how many individuals end up in each compartment. Let us assume that
individuals move from a compartment $X$ to compartments $A$, $B$, and $C$, at
rates $\lambda_A$, $\lambda_B$ and $\lambda_C$. The worflow to handle these
transitions will be:

1. determine the total number of individuals leaving $X$; this is done by
summing the rates ($\lambda = \lambda_A + \lambda_B + \lambda_C$) to compute the
*per capita* probability of leaving
$X$ $(p_(X \rightarrow ...) = 1 - e^{- \lambda})$,
and drawing the number of individuals leaving $X$ ($n_{_(X \rightarrow ...)}$)
from a binomial distribution
$n_{(X \rightarrow ...)} \sim B(X, p_(X \rightarrow ...))$

2. compute relative probabilities of moving to the different compartments (using
$i$ as a placeolder for $A$, $B$, $C$): $p_i = \frac{\lambda_i}{\sum_i \lambda_i}$

3. determine the numbers of individuals moving to $A$, $B$ and $C$ using a
Multinomial distribution:
$n_{(X \rightarrow A, B, C)} \sim \mathcal{M}(n_{(X \rightarrow ...)}, p_A, p_B, p_C)$




# Implementation using *odin*
## Discrete, deterministic SIR model

We start by loading the *odin* code for a discrete, stochastic SIR model:

``` {r load_sir}
path_sir_model <- system.file("examples/discrete_deterministic_sir.R", package = "odin")
```

``` {r echo = FALSE, results = "asis"}
cat(readLines(path_sir_model), sep = "\n")
```


As said in the previous vignette, remember this looks and parses like R code,
but is not actually R code. Copy-pasting this in a R session will trigger
errors.

We then use `odin` to compile this model:
``` {r }
sir_model <- odin::odin(path_sir_model, verbose = FALSE, skip_cache = TRUE)
sir_model
```

**Note**: this is the slow part (generation and compilation of C code for the
local machine)! Which means for computer-intensive work, the number of times
this is done should be minimized.

The returned object `sir_model` is a function that will generate an instance
of the model:
``` {r }
x <- sir_model()
x
```

`x` is an `ode_model` object which can be used to generate dynamics of a
discrete-time, deterministic SIR model. This is achieved using the function
`x$run()`, providing time steps as single argument, e.g.:

``` {r sir-deterministic}
sir_col <- c("#8c8cd9", "#cc0044", "#999966")
x$run(0:10)
x_res <- x$run(0:200)
matplot(x_res[, 1], x_res[, -1], xlab = "Time", ylab = "Number of individuals",
        main = "Discrete SIR model - deterministic", type = "l", col = sir_col,
        lwd = 3, lty = 1)
legend("topright", lwd = 3, col = sir_col, legend = c("S", "I", "R"))
```



Stochastic discrete SIR

The stochastic equivalent of the previous model can be formulated in `odin`
as follows:

``` {r load_sir_s}
path_sir_model_s <- system.file("examples/discrete_stochastic_sir.R", package = "odin")
```

``` {r echo = FALSE, results = "asis"}
cat(readLines(path_sir_model_s), sep = "\n")
```


We can use the same workflow as before to run the model:
``` {r }
sir_model_s <- odin::odin(path_sir_model_s, verbose = FALSE, skip_cache = TRUE)
sir_model_s
x <- sir_model_s(I_ini = 10) # customise param: I_ini = 10 individuals
```

``` {r sir-stochastic_1}
set.seed(1)
x_res <- x$run(0:100)
matplot(x_res[, 1], x_res[, -1], xlab = "Time", ylab = "Number of individuals",
        main = "Discrete SIR model - stochastic", type = "l", col = sir_col,
        lwd = 3, lty = 1)
legend("topright", lwd = 3, col = sir_col, legend = c("S", "I", "R"))
```


This gives us a single stochastic realisation of the model, which is of
limited interest. As an alternative, we can generate a large number of
replicates using arrays for each compartments:

``` {r }
path_sir_model_s <- system.file("examples/discrete_stochastic_sir_arrays.R", package = "odin")
```

``` {r echo = FALSE, results = "asis"}
cat(readLines(path_sir_model_s), sep = "\n")

sir_model_s <- odin::odin(path_sir_model_s, verbose = FALSE, skip_cache = TRUE)
sir_model_s
x <- sir_model_s()
```

``` {r transp}
transp <- function(col, alpha = 0.5) {
    res <- apply(col2rgb(col), 2,
                 function(c) rgb(c[1]/255, c[2]/255, c[3]/255, alpha))
    return(res)
}
```

``` {r sir-stochastic_100}
set.seed(1)
x_res <- x$run(0:100)
matplot(x_res[, 1], x_res[, -1], xlab = "Time", ylab = "Number of individuals",
        main = "Discrete SIR model - stochastic", type = "l",
        col = rep(transp(sir_col), each = 100),
        lwd = 3, lty = 1)
legend("left", lwd = 3, col = sir_col, legend = c("S", "I", "R"))
```
